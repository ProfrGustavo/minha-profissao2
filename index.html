<!-- mural-profissional.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural Profissional da Turma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-perfil {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-perfil input,
        .form-perfil textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .perfil-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .perfil-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .mensagem-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .mensagem-item {
            background: white;
            padding: 15px;
            border-left: 4px solid #667eea;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        .erro {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .sucesso {
            background: #00C851;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .foto-perfil {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .aba-botoes {
            text-align: center;
            margin-bottom: 20px;
        }

        .aba-botoes button {
            margin: 0 5px;
        }
    </style>
    <!-- Supabase JS (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Mural Profissional da Turma</h1>
            <p>Crie seu perfil e receba mensagens dos colegas!</p>
        </div>

        <!-- Abas para alternar entre Criar Perfil e Ver Perfis -->
        <div class="aba-botoes">
            <button onclick="mostrarAba('criar')">‚ûï Criar Perfil</button>
            <button onclick="mostrarAba('ver')">üë• Ver Perfis</button>
        </div>

        <!-- ABA 1: Criar Perfil -->
        <div id="aba-criar" class="form-perfil">
            <h2 style="margin-bottom: 20px;">Crie seu Perfil</h2>
            
            <div id="mensagem-criar"></div>
            
            <input type="text" id="nome" placeholder="Seu nome completo" required>
            <input type="text" id="profissao" placeholder="Sua profiss√£o (ex: Estudante de Programa√ß√£o)" required>
            <textarea id="descricao" placeholder="Fale um pouco sobre voc√™..." rows="4"></textarea>
            <input type="url" id="foto" placeholder="URL da sua foto (opcional)">
            
            <button onclick="criarPerfil()">Criar Perfil</button>
        </div>

        <!-- ABA 2: Ver Perfis e Mensagens -->
        <div id="aba-ver" style="display: none;">
            <div id="lista-perfis" class="loading">Carregando perfis...</div>
            
            <!-- √Årea de mensagens (aparece quando seleciona um perfil) -->
            <div id="area-mensagens" style="display: none; margin-top: 30px;">
                <div class="form-perfil">
                    <h3 id="titulo-perfil"></h3>
                    
                    <div class="mensagem-form">
                        <h4>Deixe uma mensagem</h4>
                        <input type="text" id="nome-remetente" placeholder="Seu nome" style="margin: 10px 0;">
                        <textarea id="texto-mensagem" placeholder="Sua mensagem..." rows="3" style="margin: 10px 0;"></textarea>
                        <button onclick="enviarMensagem()">Enviar Mensagem</button>
                    </div>
                    
                    <div id="lista-mensagens" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üîë CONFIGURA√á√ÉO √öNICA - COLE SEUS DADOS AQUI
        const SUPABASE_URL = 'https://ipfkiedyuvfbqgwhpjrg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_CzeOb-GVArfflJbOa01nmA_Url_bcvt';
        
        // Inicializar Supabase (UMA √öNICA VEZ)
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Vari√°veis globais
        let perfilSelecionado = null;

        // Fun√ß√µes globais
        window.mostrarAba = function(aba) {
            console.log('Mostrando aba:', aba);
            const abaCriar = document.getElementById('aba-criar');
            const abaVer = document.getElementById('aba-ver');
            
            if (abaCriar && abaVer) {
                if (aba === 'criar') {
                    abaCriar.style.display = 'block';
                    abaVer.style.display = 'none';
                } else {
                    abaCriar.style.display = 'none';
                    abaVer.style.display = 'block';
                    carregarPerfis();
                }
            }
        };

        window.criarPerfil = async function() {
            console.log('Iniciando cria√ß√£o de perfil...');
            
            const nome = document.getElementById('nome')?.value;
            const profissao = document.getElementById('profissao')?.value;
            const descricao = document.getElementById('descricao')?.value;
            const foto_url = document.getElementById('foto')?.value;
            
            console.log('Dados:', { nome, profissao, descricao, foto_url });
            
            if (!nome || !profissao) {
                mostrarMensagem('criar', 'Preencha nome e profiss√£o!', 'erro');
                return;
            }
            
            try {
                // Criar slug simples
                const slug = nome.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
                
                console.log('Slug gerado:', slug);
                
                const { data, error } = await supabaseClient
                    .from('perfis')
                    .insert([
                        {
                            nome: nome,
                            profissao: profissao,
                            descricao: descricao || '',
                            foto_url: foto_url || null,
                            slug: slug
                        }
                    ]);
                
                if (error) {
                    console.error('Erro do Supabase:', error);
                    throw error;
                }
                
                console.log('Perfil criado:', data);
                mostrarMensagem('criar', 'Perfil criado com sucesso!', 'sucesso');
                
                // Limpar formul√°rio
                document.getElementById('nome').value = '';
                document.getElementById('profissao').value = '';
                document.getElementById('descricao').value = '';
                document.getElementById('foto').value = '';
                
            } catch (error) {
                console.error('Erro detalhado:', error);
                let mensagem = 'Erro ao criar perfil: ';
                
                if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                    mensagem = '‚ùå Tabela "perfis" n√£o existe! Crie as tabelas no SQL Editor do Supabase.';
                    console.log('%c‚ö†Ô∏è EXECUTE ESTE SQL NO SUPABASE:', 'font-size: 16px; font-weight: bold; color: red;');
                    console.log(`
                        CREATE TABLE perfis (
                            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                            nome TEXT NOT NULL,
                            profissao TEXT NOT NULL,
                            descricao TEXT,
                            foto_url TEXT,
                            slug TEXT UNIQUE,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );

                        CREATE TABLE mensagens (
                            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                            perfil_id UUID REFERENCES perfis(id) ON DELETE CASCADE,
                            nome_remetente TEXT NOT NULL,
                            mensagem TEXT NOT NULL,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );

                        ALTER TABLE perfis ENABLE ROW LEVEL SECURITY;
                        ALTER TABLE mensagens ENABLE ROW LEVEL SECURITY;

                        CREATE POLICY "Permitir tudo perfis" ON perfis FOR ALL USING (true);
                        CREATE POLICY "Permitir tudo mensagens" ON mensagens FOR ALL USING (true);
                    `);
                } else {
                    mensagem += error.message || 'Erro desconhecido';
                }
                
                mostrarMensagem('criar', mensagem, 'erro');
            }
        };

        window.selecionarPerfil = async function(id, nome) {
            console.log('Perfil selecionado:', id, nome);
            perfilSelecionado = id;
            const tituloPerfil = document.getElementById('titulo-perfil');
            const areaMensagens = document.getElementById('area-mensagens');
            
            if (tituloPerfil) tituloPerfil.innerHTML = `Mensagens para ${nome}`;
            if (areaMensagens) areaMensagens.style.display = 'block';
            
            await carregarMensagens();
        };

        window.enviarMensagem = async function() {
            const nome = document.getElementById('nome-remetente')?.value;
            const texto = document.getElementById('texto-mensagem')?.value;
            
            if (!nome || !texto) {
                alert('Preencha seu nome e a mensagem!');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('mensagens')
                    .insert([
                        {
                            perfil_id: perfilSelecionado,
                            nome_remetente: nome,
                            mensagem: texto
                        }
                    ]);
                
                if (error) throw error;
                
                // Limpar formul√°rio
                document.getElementById('nome-remetente').value = '';
                document.getElementById('texto-mensagem').value = '';
                
                // Recarregar mensagens
                await carregarMensagens();
                
                alert('Mensagem enviada com sucesso!');
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('Erro ao enviar mensagem: ' + (error.message || 'Erro desconhecido'));
            }
        };

        // Fun√ß√µes internas
        async function carregarPerfis() {
            console.log('Carregando perfis...');
            
            try {
                const { data: perfis, error } = await supabaseClient
                    .from('perfis')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const listaPerfis = document.getElementById('lista-perfis');
                
                if (!perfis || perfis.length === 0) {
                    listaPerfis.innerHTML = '<p style="text-align: center; padding: 40px;">Nenhum perfil cadastrado ainda. Crie o seu!</p>';
                    return;
                }
                
                listaPerfis.innerHTML = perfis.map(perfil => `
                    <div class="perfil-card" onclick="selecionarPerfil('${perfil.id}', '${perfil.nome}')">
                        ${perfil.foto_url ? `<img src="${perfil.foto_url}" alt="${perfil.nome}" class="foto-perfil">` : ''}
                        <h3>${perfil.nome}</h3>
                        <p><strong>${perfil.profissao}</strong></p>
                        <p>${perfil.descricao || ''}</p>
                        <small>üì® Clique para ver mensagens</small>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar perfis:', error);
                document.getElementById('lista-perfis').innerHTML = '<p class="erro">Erro ao carregar perfis. Verifique o console.</p>';
            }
        }

        async function carregarMensagens() {
            if (!perfilSelecionado) return;
            
            console.log('Carregando mensagens do perfil:', perfilSelecionado);
            
            try {
                const { data: mensagens, error } = await supabaseClient
                    .from('mensagens')
                    .select('*')
                    .eq('perfil_id', perfilSelecionado)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const listaMensagens = document.getElementById('lista-mensagens');
                
                if (!mensagens || mensagens.length === 0) {
                    listaMensagens.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhuma mensagem ainda. Seja o primeiro a comentar!</p>';
                    return;
                }
                
                listaMensagens.innerHTML = mensagens.map(msg => `
                    <div class="mensagem-item">
                        <strong>${msg.nome_remetente}</strong>
                        <small style="float: right;">${new Date(msg.created_at).toLocaleString('pt-BR')}</small>
                        <p style="margin-top: 10px;">${msg.mensagem}</p>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        function mostrarMensagem(local, texto, tipo) {
            const div = document.getElementById(`mensagem-${local}`);
            if (!div) return;
            div.innerHTML = `<div class="${tipo}">${texto}</div>`;
            setTimeout(() => {
                div.innerHTML = '';
            }, 5000);
        }

        // Inicializa√ß√£o
        (function() {
            console.log('Iniciando aplica√ß√£o...');
            console.log('URL:', SUPABASE_URL);
            console.log('Key:', SUPABASE_KEY.substring(0, 10) + '...');
            
            // Mostrar aba criar por padr√£o
            if (typeof window.mostrarAba === 'function') {
                window.mostrarAba('criar');
            }
        })();
    </script>
</body>
</html>